<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supermart Vendor Management System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .save-status {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      background: #4caf50;
      color: white;
    }

    .content {
      padding: 30px;
    }

    .backup-section {
      background: #e8f5e8;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
      text-align: center;
    }

    .tabs {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 15px 25px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .tab.active {
      color: #3498db;
      border-bottom-color: #3498db;
    }

    .tab:hover {
      color: #3498db;
      background: #f8f9fa;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #27ae60, #229954);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    .th {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      border-left: 4px solid #3498db;
    }

    .summary-card h3 {
      font-size: 2rem;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .summary-card p {
      color: #666;
      font-weight: 600;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }

    .alert-success {
      background: #e8f5e8;
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }

    .alert-warning {
      background: #fff3e0;
      color: #ef6c00;
      border-left: 4px solid #ff9800;
    }

    .alert-danger {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }

    .search-filter {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-filter input,
    .search-filter select {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .issue-item {
      background: #ffebee;
      border: 1px solid #ffcdd2;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    .issue-item.resolved {
      background: #e8f5e8;
      border-color: #c8e6c9;
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .issue-date {
      font-size: 0.85rem;
      color: #666;
      font-weight: 600;
    }

    .resolve-btn {
      padding: 5px 12px;
      font-size: 0.8rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="save-status" id="saveStatus">üü¢ Connected</div>
      <h1>üõí Supermart Vendor Management</h1>
      <p>Automatic Database.json File Management</p>
    </div>

    <div class="content">
      <div class="backup-section">
        <h3>üíæ Database Management</h3>
        <div class="alert alert-success">
          <strong>üîÑ Auto-Save:</strong> All changes are automatically saved to database.json file. No manual saving
          required!
        </div>
        <button class="btn btn-warning" onclick="createBackup()">üì¶ Create Backup</button>
        <div id="dataStatus" style="margin-top: 15px; font-size: 0.9rem; color: #666;"></div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('vendors')">Vendor Management</button>
        <button class="tab" onclick="showTab('brands')">Vendor Brands</button>
        <button class="tab" onclick="showTab('issues')">Expired/Damaged Items</button>
        <button class="tab" onclick="showTab('reports')">Reports & Export</button>
      </div>

      <div id="vendors" class="tab-content active">
        <h2>Add New Vendor</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Vendor Name*</label>
            <input type="text" id="vendorName" placeholder="e.g., ABC Distributors" required>
          </div>
          <div class="form-group">
            <label>Contact Person</label>
            <input type="text" id="contactPerson" placeholder="Sales representative name">
          </div>
          <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" id="phoneNumber" placeholder="+91 9876543210">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" placeholder="vendor@company.com">
          </div>
          <div class="form-group">
            <label>Payment Terms</label>
            <select id="paymentTerms">
              <option value="advance">Advance Payment Required</option>
              <option value="credit">Credit (Pay After Sale)</option>
              <option value="mixed">Mixed Terms</option>
            </select>
          </div>
          <div class="form-group">
            <label>Visit Frequency</label>
            <select id="visitFrequency">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Bi-weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div class="form-group">
            <label>Last Visit Date</label>
            <input type="date" id="lastVisit">
          </div>
          <div class="form-group">
            <label>Next Expected Visit</label>
            <input type="date" id="nextVisit">
          </div>
          <div class="form-group">
            <label>Display Space</label>
            <select id="hasDisplay">
              <option value="no">No Display</option>
              <option value="yes">Has Display Space</option>
            </select>
          </div>
          <div class="form-group">
            <label>Display Rent (‚Çπ/month)</label>
            <input type="number" id="displayRent" placeholder="0" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>Terms & Conditions</label>
          <textarea id="termsConditions"
            placeholder="Enter any special terms, return policies, credit limits, etc."></textarea>
        </div>
        <div class="form-group">
          <label>Remarks</label>
          <textarea id="remarks" placeholder="Additional notes about this vendor"></textarea>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="addVendor()">Add Vendor</button>
          <button class="btn btn-warning" onclick="clearVendorForm()">Clear Form</button>
        </div>

        <div class="table-container">
          <h3>Current Vendors</h3>
          <table id="vendorTable">
            <thead>
              <tr class="th">
                <th>Vendor Name</th>
                <th>Contact Person</th>
                <th>Phone</th>
                <th>Payment Terms</th>
                <th>Visit Frequency</th>
                <th>Last Visit</th>
                <th>Next Visit</th>
                <th>Display Rent</th>
                <th>Pending Issues</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="vendorTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="brands" class="tab-content">
        <h2>Manage Vendor Brands/Products</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Select Vendor*</label>
            <select id="brandVendor" required>
              <option value="">Choose a vendor...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Brand/Product Name*</label>
            <input type="text" id="brandName" placeholder="e.g., Maggi Noodles, Britannia Biscuits, etc." required>
          </div>
          <div class="form-group">
            <label>SKU/Product Code</label>
            <input type="text" id="brandSKU" placeholder="Optional: Product SKU or code">
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="brandCategory">
              <option value="groceries">Groceries</option>
              <option value="dairy">Dairy Products</option>
              <option value="beverages">Beverages</option>
              <option value="snacks">Snacks</option>
              <option value="personal_care">Personal Care</option>
              <option value="household">Household Items</option>
              <option value="bakery">Bakery</option>
              <option value="frozen">Frozen Foods</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="addBrand()">Add Brand/Product</button>
          <button class="btn btn-warning" onclick="clearBrandForm()">Clear Form</button>
        </div>

        <div class="table-container">
          <table id="brandTable">
            <thead>
              <tr class="th">
                <th>Brand/Product Name</th>
                <th>Vendor</th>
                <th>Category</th>
                <th>SKU/Code</th>
                <th>Date Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="brandTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="issues" class="tab-content">
        <h2>Expired/Damaged Items Tracking</h2>
        <div class="summary-cards">
          <div class="summary-card">
            <h3 id="pendingIssuesCount">0</h3>
            <p>Pending Issues</p>
          </div>
          <div class="summary-card">
            <h3 id="resolvedIssuesCount">0</h3>
            <p>Resolved Issues</p>
          </div>
          <div class="summary-card">
            <h3 id="totalIssuesCount">0</h3>
            <p>Total Issues</p>
          </div>
          <div class="summary-card">
            <h3 id="totalLossAmount">‚Çπ0</h3>
            <p>Total Loss Value</p>
          </div>
        </div>

        <h3>Report New Issue</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Select Vendor*</label>
            <select id="issueVendor" required>
              <option value="">Choose a vendor...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Product Name/Brand*</label>
            <input type="text" id="issueProduct" placeholder="e.g., Maggi Noodles 70g" required>
          </div>
          <div class="form-group">
            <label>Issue Type*</label>
            <select id="issueType" required>
              <option value="">Select issue type...</option>
              <option value="expired">Expired Product</option>
              <option value="damaged">Damaged Product</option>
              <option value="defective">Defective Product</option>
              <option value="wrong_delivery">Wrong Product Delivered</option>
              <option value="poor_quality">Poor Quality</option>
              <option value="short_delivery">Short Delivery</option>
              <option value="other">Other Issue</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity Affected</label>
            <input type="number" id="issueQuantity" placeholder="Number of units affected" min="1">
          </div>
          <div class="form-group">
            <label>Date Found</label>
            <input type="date" id="issueDate">
          </div>
          <div class="form-group">
            <label>Estimated Loss (‚Çπ)</label>
            <input type="number" id="issueLoss" placeholder="Estimated financial loss" step="0.01" min="0">
          </div>
        </div>
        <div class="form-group">
          <label>Issue Description</label>
          <textarea id="issueDescription"
            placeholder="Describe the issue in detail (expiry date, damage details, what to discuss with vendor)"></textarea>
        </div>
        <div class="actions">
          <button class="btn btn-danger" onclick="addIssue()">Report Issue</button>
          <button class="btn btn-warning" onclick="clearIssueForm()">Clear Form</button>
        </div>

        <div id="issuesList"></div>
      </div>

      <div id="reports" class="tab-content">
        <h2>Reports & Data Export</h2>
        <div class="summary-cards">
          <div class="summary-card">
            <h3 id="reportVendorCount">0</h3>
            <p>Total Vendors</p>
          </div>
          <div class="summary-card">
            <h3 id="reportBrandCount">0</h3>
            <p>Brands/Products</p>
          </div>
          <div class="summary-card">
            <h3 id="reportPendingCount">0</h3>
            <p>Pending Issues</p>
          </div>
          <div class="summary-card">
            <h3 id="reportDisplayRevenue">‚Çπ0</h3>
            <p>Monthly Display Revenue</p>
          </div>
        </div>

        <div class="alert alert-info">
          <strong>üì§ Export Options:</strong> Download Excel reports for vendor meetings and accounting.
        </div>

        <div class="actions" style="justify-content: center;">
          <button class="btn btn-success" onclick="exportVendorData()">üì§ Export Vendor Data</button>
          <button class="btn btn-success" onclick="exportBrandData()">üì§ Export Brand Lists</button>
          <button class="btn btn-danger" onclick="exportIssuesReport()">‚ö†Ô∏è Export Issues Report</button>
          <button class="btn btn-primary" onclick="exportCompleteData()">üìã Export Complete Database</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let vendors = [];
    let brands = [];
    let issues = [];

    // API functions
    async function apiCall(endpoint, method = 'GET', data = null) {
      try {
        const options = {
          method,
          headers: {'Content-Type': 'application/json'}
        };

        if (data) {
          options.body = JSON.stringify(data);
        }

        const response = await fetch(endpoint, options);
        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        document.getElementById('saveStatus').textContent = '‚ùå Connection Error';
        throw error;
      }
    }

    async function loadData() {
      try {
        document.getElementById('saveStatus').textContent = 'üîÑ Loading...';
        const data = await apiCall('/api/data');

        vendors = data.vendors || [];
        brands = data.brands || [];
        issues = data.issues || [];

        updateAllTables();
        updateDataStatus();
        document.getElementById('saveStatus').textContent = 'üü¢ Connected';
      } catch (error) {
        document.getElementById('saveStatus').textContent = '‚ùå Load Failed';
      }
    }

    function updateDataStatus() {
      const statusDiv = document.getElementById('dataStatus');
      statusDiv.innerHTML = `üìä Current: ${vendors.length} vendors, ${brands.length} brands, ${issues.length} issues | Last updated: ${new Date().toLocaleString()}`;
    }

    function updateAllTables() {
      updateVendorDropdowns();
      updateVendorTable();
      updateBrandTable();
      updateIssuesDisplay();
      updateReportSummary();
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      if (tabName === 'issues') updateIssuesDisplay();
      if (tabName === 'reports') updateReportSummary();
    }

    async function addVendor() {
      const vendorData = {
        name: document.getElementById('vendorName').value,
        contactPerson: document.getElementById('contactPerson').value,
        phone: document.getElementById('phoneNumber').value,
        email: document.getElementById('email').value,
        paymentTerms: document.getElementById('paymentTerms').value,
        visitFrequency: document.getElementById('visitFrequency').value,
        lastVisit: document.getElementById('lastVisit').value,
        nextVisit: document.getElementById('nextVisit').value,
        hasDisplay: document.getElementById('hasDisplay').value,
        displayRent: parseFloat(document.getElementById('displayRent').value) || 0,
        termsConditions: document.getElementById('termsConditions').value,
        remarks: document.getElementById('remarks').value
      };

      if (!vendorData.name) {
        alert('Please enter vendor name');
        return;
      }

      try {
        const result = await apiCall('/api/vendors', 'POST', vendorData);
        if (result.success) {
          vendors.push(result.vendor);
          updateVendorDropdowns();
          updateVendorTable();
          clearVendorForm();
          updateDataStatus();
          alert('‚úÖ Vendor added and saved automatically!');
        }
      } catch (error) {
        alert('‚ùå Failed to add vendor');
      }
    }

    function clearVendorForm() {
      document.getElementById('vendorName').value = '';
      document.getElementById('contactPerson').value = '';
      document.getElementById('phoneNumber').value = '';
      document.getElementById('email').value = '';
      document.getElementById('paymentTerms').value = 'advance';
      document.getElementById('visitFrequency').value = 'weekly';
      document.getElementById('lastVisit').value = '';
      document.getElementById('nextVisit').value = '';
      document.getElementById('hasDisplay').value = 'no';
      document.getElementById('displayRent').value = '';
      document.getElementById('termsConditions').value = '';
      document.getElementById('remarks').value = '';
    }

    function updateVendorDropdowns() {
      const selects = ['brandVendor', 'issueVendor'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '<option value="">Choose a vendor...</option>';
          vendors.forEach(vendor => {
            const option = document.createElement('option');
            option.value = vendor.id;
            option.textContent = vendor.name;
            select.appendChild(option);
          });
        }
      });
    }

    function updateVendorTable() {
      const tbody = document.getElementById('vendorTableBody');
      tbody.innerHTML = '';
      vendors.forEach(vendor => {
        const pendingIssues = issues.filter(issue => issue.vendorId === vendor.id && issue.status === 'pending');
        const row = document.createElement('tr');
        row.innerHTML = `
                    <td>${vendor.name}</td>
                    <td>${vendor.contactPerson || '-'}</td>
                    <td>${vendor.phone || '-'}</td>
                    <td>${vendor.paymentTerms}</td>
                    <td>${vendor.visitFrequency}</td>
                    <td>${vendor.lastVisit || '-'}</td>
                    <td>${vendor.nextVisit || '-'}</td>
                    <td>‚Çπ${vendor.displayRent}</td>
                    <td><span style="background: ${pendingIssues.length > 0 ? '#ffebee' : '#e8f5e8'}; color: ${pendingIssues.length > 0 ? '#c62828' : '#2e7d32'}; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${pendingIssues.length}</span></td>
                    <td><button class="btn btn-danger" onclick="removeVendor(${vendor.id})" style="padding: 5px 10px; font-size: 0.8rem;">Remove</button></td>
                `;
        tbody.appendChild(row);
      });
    }

    async function removeVendor(vendorId) {
      if (confirm('Remove vendor and all associated data?')) {
        try {
          await apiCall(`/api/vendors/${vendorId}`, 'DELETE');
          vendors = vendors.filter(v => v.id !== vendorId);
          brands = brands.filter(b => b.vendorId !== vendorId);
          issues = issues.filter(i => i.vendorId !== vendorId);
          updateAllTables();
          updateDataStatus();
          alert('‚úÖ Vendor removed and database updated!');
        } catch (error) {
          alert('‚ùå Failed to remove vendor');
        }
      }
    }

    async function addBrand() {
      const brandData = {
        vendorId: parseInt(document.getElementById('brandVendor').value),
        name: document.getElementById('brandName').value,
        sku: document.getElementById('brandSKU').value,
        category: document.getElementById('brandCategory').value
      };

      if (!brandData.vendorId || !brandData.name) {
        alert('Please select vendor and enter brand/product name');
        return;
      }

      try {
        const result = await apiCall('/api/brands', 'POST', brandData);
        if (result.success) {
          brands.push(result.brand);
          updateBrandTable();
          clearBrandForm();
          updateDataStatus();
          alert('‚úÖ Brand added and saved automatically!');
        }
      } catch (error) {
        alert('‚ùå Failed to add brand');
      }
    }

    function clearBrandForm() {
      document.getElementById('brandVendor').value = '';
      document.getElementById('brandName').value = '';
      document.getElementById('brandSKU').value = '';
      document.getElementById('brandCategory').value = 'groceries';
    }

    function updateBrandTable() {
      const tbody = document.getElementById('brandTableBody');
      tbody.innerHTML = '';
      brands.forEach(brand => {
        const vendor = vendors.find(v => v.id === brand.vendorId);
        const row = document.createElement('tr');
        row.innerHTML = `
                    <td>${brand.name}</td>
                    <td>${vendor ? vendor.name : 'Unknown'}</td>
                    <td>${brand.category}</td>
                    <td>${brand.sku || '-'}</td>
                    <td>${brand.dateAdded}</td>
                    <td><button class="btn btn-danger" onclick="removeBrand(${brand.id})" style="padding: 5px 10px; font-size: 0.8rem;">Remove</button></td>
                `;
        tbody.appendChild(row);
      });
    }

    async function removeBrand(brandId) {
      if (confirm('Remove this brand/product?')) {
        try {
          await apiCall(`/api/brands/${brandId}`, 'DELETE');
          brands = brands.filter(b => b.id !== brandId);
          updateBrandTable();
          updateDataStatus();
          alert('‚úÖ Brand removed and database updated!');
        } catch (error) {
          alert('‚ùå Failed to remove brand');
        }
      }
    }

    async function addIssue() {
      const issueData = {
        vendorId: parseInt(document.getElementById('issueVendor').value),
        productName: document.getElementById('issueProduct').value,
        issueType: document.getElementById('issueType').value,
        quantity: parseInt(document.getElementById('issueQuantity').value) || 1,
        dateFound: document.getElementById('issueDate').value || new Date().toISOString().split('T')[0],
        estimatedLoss: parseFloat(document.getElementById('issueLoss').value) || 0,
        description: document.getElementById('issueDescription').value
      };

      if (!issueData.vendorId || !issueData.productName || !issueData.issueType) {
        alert('Please fill all required fields');
        return;
      }

      try {
        const result = await apiCall('/api/issues', 'POST', issueData);
        if (result.success) {
          issues.push(result.issue);
          updateIssuesDisplay();
          updateVendorTable();
          clearIssueForm();
          updateDataStatus();
          alert('‚úÖ Issue reported and saved automatically!');
        }
      } catch (error) {
        alert('‚ùå Failed to report issue');
      }
    }

    function clearIssueForm() {
      document.getElementById('issueVendor').value = '';
      document.getElementById('issueProduct').value = '';
      document.getElementById('issueType').value = '';
      document.getElementById('issueQuantity').value = '';
      document.getElementById('issueDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('issueLoss').value = '';
      document.getElementById('issueDescription').value = '';
    }

    function updateIssuesDisplay() {
      const pendingIssues = issues.filter(issue => issue.status === 'pending');
      const resolvedIssues = issues.filter(issue => issue.status === 'resolved');
      const totalLoss = issues.reduce((sum, issue) => sum + issue.estimatedLoss, 0);

      document.getElementById('pendingIssuesCount').textContent = pendingIssues.length;
      document.getElementById('resolvedIssuesCount').textContent = resolvedIssues.length;
      document.getElementById('totalIssuesCount').textContent = issues.length;
      document.getElementById('totalLossAmount').textContent = `‚Çπ${totalLoss}`;

      const issuesList = document.getElementById('issuesList');
      issuesList.innerHTML = '';

      if (issues.length === 0) {
        issuesList.innerHTML = '<div class="alert alert-success">No issues reported yet. Great job!</div>';
        return;
      }

      const sortedIssues = [...issues].sort((a, b) => {
        if (a.status !== b.status) return a.status === 'pending' ? -1 : 1;
        return new Date(b.dateFound) - new Date(a.dateFound);
      });

      sortedIssues.forEach(issue => {
        const vendor = vendors.find(v => v.id === issue.vendorId);
        const issueDiv = document.createElement('div');
        issueDiv.className = `issue-item ${issue.status === 'resolved' ? 'resolved' : ''}`;

        const daysPending = issue.status === 'pending' ?
          Math.ceil((new Date() - new Date(issue.dateFound)) / (1000 * 60 * 60 * 24)) : 0;

        issueDiv.innerHTML = `
                    <div class="issue-header">
                        <div>
                            <strong>${issue.productName}</strong> - ${vendor ? vendor.name : 'Unknown Vendor'}
                            <div class="issue-date">Found: ${issue.dateFound} | Type: ${issue.issueType.toUpperCase()} ${issue.status === 'pending' && daysPending > 0 ? `| ${daysPending} days pending` : ''}</div>
                        </div>
                        <div>
                            ${issue.status === 'pending' ?
            `<button class="btn btn-success resolve-btn" onclick="resolveIssue(${issue.id})">Mark Resolved</button>` :
            `<span style="color: #2e7d32; font-weight: 600;">‚úÖ RESOLVED (${issue.resolvedDate})</span>`
          }
                        </div>
                    </div>
                    <div>
                        <p><strong>Quantity:</strong> ${issue.quantity} units | <strong>Estimated Loss:</strong> ‚Çπ${issue.estimatedLoss}</p>
                        ${issue.description ? `<p><strong>Description:</strong> ${issue.description}</p>` : ''}
                        ${vendor && vendor.phone ? `<p><strong>Vendor Contact:</strong> ${vendor.phone}</p>` : ''}
                    </div>
                `;

        issuesList.appendChild(issueDiv);
      });
    }

    async function resolveIssue(issueId) {
      if (confirm('Mark this issue as resolved?')) {
        try {
          await apiCall(`/api/issues/${issueId}`, 'PUT', {status: 'resolved'});
          const issue = issues.find(i => i.id === issueId);
          if (issue) {
            issue.status = 'resolved';
            issue.resolvedDate = new Date().toISOString().split('T')[0];
          }
          updateIssuesDisplay();
          updateVendorTable();
          updateDataStatus();
          alert('‚úÖ Issue marked as resolved and database updated!');
        } catch (error) {
          alert('‚ùå Failed to resolve issue');
        }
      }
    }

    function updateReportSummary() {
      const totalDisplayRevenue = vendors.reduce((sum, vendor) => sum + vendor.displayRent, 0);
      document.getElementById('reportVendorCount').textContent = vendors.length;
      document.getElementById('reportBrandCount').textContent = brands.length;
      document.getElementById('reportPendingCount').textContent = issues.filter(i => i.status === 'pending').length;
      document.getElementById('reportDisplayRevenue').textContent = `‚Çπ${totalDisplayRevenue}`;
    }

    async function createBackup() {
      try {
        window.open('/api/backup', '_blank');
        alert('‚úÖ Backup created and downloaded!');
      } catch (error) {
        alert('‚ùå Failed to create backup');
      }
    }

    function exportVendorData() {
      if (vendors.length === 0) {alert('No vendor data to export'); return;}

      const exportData = vendors.map(vendor => {
        const vendorBrands = brands.filter(b => b.vendorId === vendor.id);
        const pendingIssues = issues.filter(i => i.vendorId === vendor.id && i.status === 'pending');
        const brandNames = vendorBrands.map(b => b.name).join(', ');

        return {
          'Vendor Name': vendor.name,
          'Contact Person': vendor.contactPerson || '',
          'Phone': vendor.phone || '',
          'Email': vendor.email || '',
          'Payment Terms': vendor.paymentTerms,
          'Visit Frequency': vendor.visitFrequency,
          'Last Visit': vendor.lastVisit || '',
          'Next Visit': vendor.nextVisit || '',
          'Has Display': vendor.hasDisplay,
          'Display Rent (‚Çπ)': vendor.displayRent,
          'Brands/Products': brandNames || 'None',
          'Pending Issues': pendingIssues.length,
          'Terms & Conditions': vendor.termsConditions || '',
          'Remarks': vendor.remarks || ''
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Vendors');
      XLSX.writeFile(wb, `Vendor_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function exportBrandData() {
      if (brands.length === 0) {alert('No brand data to export'); return;}

      const exportData = brands.map(brand => {
        const vendor = vendors.find(v => v.id === brand.vendorId);
        return {
          'Brand/Product Name': brand.name,
          'Vendor Name': vendor ? vendor.name : 'Unknown',
          'Vendor Phone': vendor ? vendor.phone : '',
          'Category': brand.category,
          'SKU/Code': brand.sku || '',
          'Date Added': brand.dateAdded
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Brands');
      XLSX.writeFile(wb, `Brand_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function exportIssuesReport() {
      if (issues.length === 0) {alert('No issues to export'); return;}

      const exportData = issues.map(issue => {
        const vendor = vendors.find(v => v.id === issue.vendorId);
        const daysPending = issue.status === 'pending' ?
          Math.ceil((new Date() - new Date(issue.dateFound)) / (1000 * 60 * 60 * 24)) : '';

        return {
          'Date Found': issue.dateFound,
          'Vendor Name': vendor ? vendor.name : 'Unknown',
          'Vendor Phone': vendor ? vendor.phone : '',
          'Product Name': issue.productName,
          'Issue Type': issue.issueType.toUpperCase(),
          'Quantity Affected': issue.quantity,
          'Estimated Loss (‚Çπ)': issue.estimatedLoss,
          'Description': issue.description || '',
          'Status': issue.status.toUpperCase(),
          'Resolved Date': issue.resolvedDate || '',
          'Days Pending': daysPending,
          'Action Required': issue.status === 'pending' ? 'Discuss with vendor' : 'Resolved'
        };
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Issues Report');
      XLSX.writeFile(wb, `Issues_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    function exportCompleteData() {
      const wb = XLSX.utils.book_new();

      if (vendors.length > 0) {
        const vendorData = vendors.map(vendor => {
          const vendorBrands = brands.filter(b => b.vendorId === vendor.id);
          const pendingIssues = issues.filter(i => i.vendorId === vendor.id && i.status === 'pending');
          const brandNames = vendorBrands.map(b => b.name).join(', ');

          return {
            'Vendor Name': vendor.name,
            'Contact Person': vendor.contactPerson || '',
            'Phone': vendor.phone || '',
            'Email': vendor.email || '',
            'Payment Terms': vendor.paymentTerms,
            'Visit Frequency': vendor.visitFrequency,
            'Last Visit': vendor.lastVisit || '',
            'Next Visit': vendor.nextVisit || '',
            'Has Display': vendor.hasDisplay,
            'Display Rent (‚Çπ)': vendor.displayRent,
            'Brands/Products': brandNames || 'None',
            'Pending Issues': pendingIssues.length,
            'Terms & Conditions': vendor.termsConditions || '',
            'Remarks': vendor.remarks || ''
          };
        });

        const vendorWs = XLSX.utils.json_to_sheet(vendorData);
        XLSX.utils.book_append_sheet(wb, vendorWs, 'Vendors');
      }

      if (brands.length > 0) {
        const brandData = brands.map(brand => {
          const vendor = vendors.find(v => v.id === brand.vendorId);
          return {
            'Brand/Product Name': brand.name,
            'Vendor Name': vendor ? vendor.name : 'Unknown',
            'Category': brand.category,
            'SKU/Code': brand.sku || '',
            'Date Added': brand.dateAdded
          };
        });

        const brandWs = XLSX.utils.json_to_sheet(brandData);
        XLSX.utils.book_append_sheet(wb, brandWs, 'Brands');
      }

      if (issues.length > 0) {
        const issueData = issues.map(issue => {
          const vendor = vendors.find(v => v.id === issue.vendorId);
          return {
            'Date Found': issue.dateFound,
            'Vendor Name': vendor ? vendor.name : 'Unknown',
            'Product Name': issue.productName,
            'Issue Type': issue.issueType.toUpperCase(),
            'Quantity': issue.quantity,
            'Estimated Loss (‚Çπ)': issue.estimatedLoss,
            'Description': issue.description || '',
            'Status': issue.status.toUpperCase(),
            'Resolved Date': issue.resolvedDate || ''
          };
        });

        const issueWs = XLSX.utils.json_to_sheet(issueData);
        XLSX.utils.book_append_sheet(wb, issueWs, 'Issues');
      }

      XLSX.writeFile(wb, `Complete_Vendor_Management_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', async function () {
      document.getElementById('issueDate').value = new Date().toISOString().split('T')[0];
      await loadData();
    });
  </script>
</body>

</html>
